{% extends "base.html" %}

{% block title %}Sales Report - MediStore{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-currency-rupee me-2"></i>Sales Report</h2>
    <a href="{{ url_for('reports.index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back to Reports
    </a>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label">Quick Select</label>
                <select name="period" class="form-select" onchange="toggleCustomDates(this.value)">
                    <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                    <option value="week" {% if period == 'week' %}selected{% endif %}>Last 7 Days</option>
                    <option value="month" {% if period == 'month' %}selected{% endif %}>Last 30 Days</option>
                    <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom Range</option>
                </select>
            </div>
            <div class="col-md-2 {{ '' if period == 'custom' else 'd-none' }}" id="startDateDiv">
                <label class="form-label">Start Date</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}">
            </div>
            <div class="col-md-2 {{ '' if period == 'custom' else 'd-none' }}" id="endDateDiv">
                <label class="form-label">End Date</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-funnel me-1"></i>Apply
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title opacity-75">Total Sales</h6>
                <h2 class="mb-0">₹{{ "%.2f"|format(total_sales) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title opacity-75">Number of Sales</h6>
                <h2 class="mb-0">{{ sale_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title opacity-75">Items Sold</h6>
                <h2 class="mb-0">{{ total_items }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Daily Breakdown -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Daily Breakdown</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th class="text-center">Sales</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for date, data in daily_sales|dictsort(reverse=true) %}
                            <tr>
                                <td>{{ date.strftime('%d %b') }}</td>
                                <td class="text-center">{{ data.count }}</td>
                                <td class="text-end">₹{{ "%.2f"|format(data.amount) }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center text-muted py-3">No sales</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sales List -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Sales Details</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>ID</th>
                                <th>Date & Time</th>
                                <th>Customer</th>
                                <th class="text-center">Items</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in sales %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('sales.view_sale', sale_id=sale.id) }}">#{{ sale.id }}</a>
                                </td>
                                <td>{{ sale.sale_date.strftime('%d %b %I:%M %p') }}</td>
                                <td>{{ sale.customer_name or 'Walk-in' }}</td>
                                <td class="text-center">{{ sale.items|length }}</td>
                                <td class="text-end fw-bold">₹{{ "%.2f"|format(sale.total_amount) }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">No sales in selected period</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleCustomDates(value) {
    const show = value === 'custom';
    document.getElementById('startDateDiv').classList.toggle('d-none', !show);
    document.getElementById('endDateDiv').classList.toggle('d-none', !show);
}
</script>
{% endblock %}
